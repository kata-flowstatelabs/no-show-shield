<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>No-Show Shield</title>
  <style>
    :root{--fg:#111;--muted:#666;--ok:#0a7;--err:#c33;--bd:#e6e6e6}
    body{font:16px system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:24px auto;padding:0 16px;color:var(--fg)}
    h1{font-size:24px;margin:0 0 12px}
    h2{font-size:18px;margin:22px 0 8px}
    header{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .pill{padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:#fafafa;text-decoration:none;color:inherit}
    label{display:block;margin:10px 0 6px}
    input,select,button{font:16px system-ui;padding:10px 12px}
    input,select{width:100%}
    button{cursor:pointer;border:1px solid var(--bd);border-radius:10px;background:#fff}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:14px;margin-top:8px}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .card{border:1px solid var(--bd);border-radius:12px;padding:10px}
    .events{display:none;margin-top:8px}
    .event{display:flex;align-items:center;justify-content:space-between;border-top:1px solid var(--bd);padding:10px 6px}
    .event:first-child{border-top:none}
    .kvs{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:13px;background:#f8f8f8;border:1px solid var(--bd);border-radius:8px;padding:8px;white-space:pre-wrap}
    .links a{word-break:break-all}
  </style>
</head>
<body>
  <header>
    <a class="pill" href="/auth">üîê Google auth</a>
    <a class="pill" href="/ping" target="_blank">/ping</a>
    <a class="pill" href="/health" target="_blank">/health</a>
  </header>

  <h1>No-Show Shield ‚Äì Eml√©keztet≈ëk</h1>

  <section class="card">
    <h2>K√©zi teszt (perc alap√∫)</h2>
    <label for="email">√úgyf√©l e-mail</label>
    <input id="email" type="email" placeholder="pl. kata.flowstatelabs@gmail.com" required />
    <label for="mins">Kezd√©s ennyi perc m√∫lva</label>
    <select id="mins">
      <option value="3">3 perc (teszt)</option>
      <option value="5">5 perc</option>
      <option value="15">15 perc</option>
      <option value="60">60 perc</option>
    </select>
    <div class="row">
      <button id="save">Id≈ëpont r√∂gz√≠t√©se</button>
      <button id="clear" type="button">≈∞rlap t√∂rl√©se</button>
    </div>
    <div id="msg" class="muted"></div>
    <div id="result" class="kvs" style="display:none"></div>
  </section>

  <section class="card" style="margin-top:16px">
    <h2>Google Calendar esem√©nyek</h2>
    <div class="muted">Ha k√©ri, el≈ëbb kattints fel√ºl a <b>Google auth</b> gombra, enged√©lyezd, majd gyere vissza ide.</div>
    <div class="row" style="margin-top:6px">
      <button id="load">Esem√©nyek bet√∂lt√©se</button>
      <span id="gmsg" class="muted"></span>
    </div>
    <div id="events" class="events"></div>
  </section>

  <section class="card" style="margin-top:16px">
    <h2>Aktu√°lis √ºtemez√©s</h2>
    <div class="muted">Itt l√°tszik az utols√≥ sikeres √ºtemez√©s azonos√≠t√≥ja √©s linkjei.</div>
    <div id="last" class="kvs" style="display:none"></div>
    <div id="links" class="links" style="display:none;margin-top:8px"></div>
  </section>

  <script>
    const $ = s => document.querySelector(s);
    const fmtJSON = o => JSON.stringify(o, null, 2);

    // √úzenet helper
    const setMsg = (el, text, cls) => {
      el.className = "muted " + (cls || "");
      el.textContent = text || "";
    };

    // K√©zi √ºtemez√©s (GET alias)
    $('#save').onclick = async () => {
      const email = $('#email').value.trim();
      const minutes = parseInt($('#mins').value, 10);
      if (!email) { setMsg($('#msg'), 'Adj meg egy e-mail c√≠met.', 'err'); return; }
      setMsg($('#msg'), '√útemez√©s‚Ä¶');
      $('#save').disabled = true;
      try {
        const r = await fetch('/schedule?to=' + encodeURIComponent(email) + '&minutes=' + minutes);
        const ok = r.ok;
        let data = null;
        try { data = await r.json(); } catch {}
        if (!ok) {
          setMsg($('#msg'), 'Hiba az √ºtemez√©sn√©l.', 'err');
          $('#result').style.display = 'block';
          $('#result').textContent = data ? fmtJSON(data) : 'Ismeretlen hiba';
          return;
        }
        setMsg($('#msg'), '√útemezve ‚úì', 'ok');
        $('#result').style.display = 'block';
        $('#result').textContent = fmtJSON(data);

        // utols√≥ √ºtemez√©s blokk
        showLast({
          id: data.id,
          confirm: data.confirm || (data.links && data.links.confirm),
          cancel:  data.cancel  || (data.links && data.links.cancel),
          status:  data.status  || (data.links && data.links.status),
          startsAt: data.startsAt
        });
      } catch (e) {
        setMsg($('#msg'), 'H√°l√≥zati hiba.', 'err');
      } finally {
        $('#save').disabled = false;
      }
    };
    $('#clear').onclick = () => { $('#email').value=''; $('#mins').value='3'; setMsg($('#msg'),''); $('#result').style.display='none'; };

    // Esem√©nyek bet√∂lt√©se
    $('#load').onclick = async () => {
      setMsg($('#gmsg'), 'Bet√∂lt√©s‚Ä¶');
      const box = $('#events');
      box.style.display = 'none';
      box.innerHTML = '';
      try {
        const r = await fetch('/gcal/upcoming');
        if (r.status === 401) { setMsg($('#gmsg'), 'Nincs Google enged√©ly. Kattints fel√ºl a Google auth gombra.', 'err'); return; }
        if (!r.ok) { setMsg($('#gmsg'), 'Lista hiba.', 'err'); return; }
        const data = await r.json();
        if (!data.events?.length) { setMsg($('#gmsg'), 'Nincs k√∂zelg≈ë esem√©ny.'); return; }
        data.events.forEach(e => {
          const div = document.createElement('div');
          div.className = 'event';
          const start = e.start || '';
          div.innerHTML =
            `<div><b>${e.summary || '(n√©vtelen)'}</b><br><small>${start}</small></div>
             <button class="pill" data-id="${e.id}">√útemez√©s erre</button>`;
          box.appendChild(div);
        });
        box.style.display = 'block';
        setMsg($('#gmsg'), '');
      } catch {
        setMsg($('#gmsg'), 'H√°l√≥zati hiba.', 'err');
      }
    };

    // Deleg√°lt kattint√°s: √útemez√©s erre (POST /gcal/schedule)
    document.addEventListener('click', async (ev) => {
      const btn = ev.target;
      if (!(btn instanceof HTMLElement)) return;
      const id = btn.getAttribute('data-id');
      if (!id) return;

      const to = $('#email').value.trim();
      if (!to) { setMsg($('#msg'), 'Adj meg e-mail c√≠met a fels≈ë mez≈ëben.', 'err'); return; }

      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = '√útemez√©s‚Ä¶';

      try {
        const r = await fetch('/gcal/schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventId: id, to })
        });

        let data = null;
        try { data = await r.json(); } catch {}

        if (r.status === 401) {
          setMsg($('#msg'), 'Nincs Google enged√©ly. Kattints fel√ºl a Google auth gombra.', 'err');
          btn.textContent = 'Hiba';
          return;
        }
        if (!r.ok) {
          setMsg($('#msg'), 'Hiba a GCal √ºtemez√©sn√©l.', 'err');
          $('#result').style.display = 'block';
          $('#result').textContent = data ? fmtJSON(data) : 'Ismeretlen hiba';
          btn.textContent = 'Hiba';
          return;
        }

        // Siker
        setMsg($('#msg'), '√útemezve ‚úì', 'ok');
        $('#result').style.display = 'block';
        $('#result').textContent = fmtJSON(data);

        showLast({
          id: data.id,
          confirm: data.links?.confirm,
          cancel:  data.links?.cancel,
          status:  data.links?.status,
          startsAt: data.startsAt
        });

        btn.textContent = '√útemezve ‚úì';
      } catch {
        setMsg($('#msg'), 'H√°l√≥zati hiba.', 'err');
        btn.textContent = 'Hiba';
      } finally {
        setTimeout(() => { btn.disabled = false; btn.textContent = prev; }, 2500);
      }
    });

    function showLast(info){
      if (!info) return;
      $('#last').style.display = 'block';
      $('#last').textContent = fmtJSON(info);

      const links = [];
      if (info.confirm) links.push(`<div>Visszaigazol√°s: <a href="${info.confirm}" target="_blank">${info.confirm}</a></div>`);
      if (info.cancel)  links.push(`<div>Lemond√°s: <a href="${info.cancel}" target="_blank">${info.cancel}</a></div>`);
      if (info.status)  links.push(`<div>St√°tusz: <a href="${info.status}" target="_blank">${info.status}</a></div>`);
      $('#links').innerHTML = links.join("");
      $('#links').style.display = links.length ? 'block' : 'none';
    }
  </script>
</body>
</html>
