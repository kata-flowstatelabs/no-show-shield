<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>No-Show Shield</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--muted:#9aa4b2;--fg:#f8fafc;--accent:#22c55e;--accent2:#38bdf8;--err:#f87171;--bd:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .hero{background:radial-gradient(1200px 500px at 20% -20%,rgba(56,189,248,.15),transparent),radial-gradient(1000px 600px at 120% -40%,rgba(34,197,94,.12),transparent),var(--bg);border-bottom:1px solid #0b1326}
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 20px rgba(56,189,248,.35)}
    h1{margin:6px 0 4px;font-size:26px}
    .sub{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}
    @media (min-width:880px){.grid{grid-template-columns:1.05fr .95fr}}
    label{display:block;margin:10px 0 6px;color:#cbd5e1}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #223048;background:#0b1326;color:var(--fg)}
    button{cursor:pointer;border-radius:12px;border:1px solid #223048;background:#122036;color:#e5f0ff;padding:12px 16px;font-weight:600}
    .primary{background:linear-gradient(135deg,var(--accent),#16a34a);border:none;color:#04140b}
    .ghost{background:#0b1326}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .status{margin-top:10px;padding:12px 14px;border-radius:12px;border:1px solid #1e293b;background:#0b1326;color:#cbd5e1;display:none}
    .status.ok{border-color:#134e2a;background:#04140b;color:#b9f7d0}
    .status.err{border-color:#4c1d1d;background:#140404;color:#fecaca}
    .events{display:none;margin-top:8px}
    .event{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #162235;padding:12px 4px}
    .event:first-child{border-top:none}
    .title{font-weight:700}
    .small{color:var(--muted);font-size:13px}
    .linkrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .mini{padding:8px 12px;border-radius:10px;border:1px solid #223048;background:#0b1326;color:#cfe8ff;font-weight:600}
    .mini.primary{background:#1e293b;color:#bfe1ff}
    footer{color:var(--muted);font-size:13px;margin:28px 0 20px;text-align:center}
  </style>
</head>
<body>
  <div class="hero">
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>No-Show Shield</h1>
            <div class="sub">Automatikus e-mail eml√©keztet≈ëk a Google Napt√°r esem√©nyeidhez</div>
          </div>
        </div>
        <a class="ghost" href="/auth" style="text-decoration:none;padding:10px 14px;border-radius:12px;border:1px solid #223048;background:#0b1326;color:#cfe8ff">üîê Google auth</a>
      </header>

      <div class="grid">
        <section class="card">
          <label for="email">√úgyf√©l e-mail c√≠me</label>
          <input id="email" type="email" placeholder="pl. ugyfel@pelda.hu" />
          <div class="row" style="margin-top:12px">
            <button class="primary" id="load">Esem√©nyek bet√∂lt√©se</button>
          </div>
          <div id="gmsg" class="status"></div>
          <div id="events" class="events"></div>
        </section>

        <section class="card">
          <div class="title">Utols√≥ √ºtemez√©s</div>
          <div class="small">Azonos√≠t√≥ √©s gyorsm≈±veletek</div>
          <div id="last" style="margin-top:12px;display:none">
            <div id="lastId" class="small"></div>
            <div class="linkrow" id="rowConfirm" style="display:none">
              <button class="mini primary" id="btnConfirmOpen">Visszaigazol√°s megnyit√°sa</button>
              <button class="mini" id="btnConfirmCopy">Link m√°sol√°sa</button>
            </div>
            <div class="linkrow" id="rowCancel" style="display:none">
              <button class="mini primary" id="btnCancelOpen">Lemond√°s megnyit√°sa</button>
              <button class="mini" id="btnCancelCopy">Link m√°sol√°sa</button>
            </div>
            <div class="linkrow" id="rowStatus" style="display:none">
              <button class="mini primary" id="btnStatusOpen">St√°tusz megnyit√°sa</button>
              <button class="mini" id="btnStatusCopy">Link m√°sol√°sa</button>
            </div>
          </div>
          <div id="msg" class="status"></div>
        </section>
      </div>
    </div>
  </div>

  <div class="wrap">
    <footer>Ha k√©ri a rendszer, jelentkezz be fent a <b>Google auth</b> gombbal, majd t√©rj vissza ide.</footer>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const show = (el, cls, txt) => { el.style.display='block'; el.className='status '+(cls||''); el.textContent=txt||''; };
    const hide = el => { el.style.display='none'; el.textContent=''; };

    // Esem√©nyek bet√∂lt√©se
    $('#load').onclick = async () => {
      const email = $('#email').value.trim();
      if (!email) { show($('#msg'),'err','Adj meg e-mail c√≠met.'); return; }

      const btn = $('#load');
      btn.disabled = true; show($('#gmsg'), null, 'Bet√∂lt√©s‚Ä¶');
      $('#events').style.display='none'; $('#events').innerHTML='';

      try{
        const r = await fetch('/gcal/upcoming');
        const data = await r.json().catch(()=>null);

        if (r.status === 401) { show($('#gmsg'),'err','Nincs Google enged√©ly. Kattints a Google auth gombra.'); return; }
        if (!r.ok) { show($('#gmsg'),'err','Nem siker√ºlt bet√∂lteni az esem√©nyeket.'); return; }
        if (!data?.events?.length) { show($('#gmsg'), null,'Nincs k√∂zelg≈ë esem√©ny.'); return; }

        hide($('#gmsg'));
        const box = $('#events');
        data.events.forEach(e=>{
          const div = document.createElement('div');
          div.className='event';
          div.innerHTML = `
            <div>
              <div class="title">${e.summary || '(n√©vtelen)'}</div>
              <div class="small">${e.start || ''}</div>
            </div>
            <button class="primary" data-id="${e.id}">√útemez√©s erre</button>`;
          box.appendChild(div);
        });
        box.style.display='block';
      }catch{
        show($('#gmsg'),'err','H√°l√≥zati hiba.');
      }finally{
        btn.disabled=false;
      }
    };

    // √útemez√©s gombok
    document.addEventListener('click', async (ev)=>{
      const b = ev.target;
      if (!(b instanceof HTMLElement)) return;
      const id = b.getAttribute('data-id');
      if (!id) return;

      const to = $('#email').value.trim();
      if (!to) { show($('#msg'),'err','Adj meg e-mail c√≠met.'); return; }

      const prev=b.textContent; b.disabled=true; b.textContent='√útemez√©s‚Ä¶';
      try{
        const r = await fetch('/gcal/schedule', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ eventId:id, to })
        });
        const data = await r.json().catch(()=>null);

        if (r.status === 401) { show($('#msg'),'err','Nincs Google enged√©ly. Kattints a Google auth gombra.'); b.textContent='Hiba'; return; }
        if (!r.ok) { show($('#msg'),'err','Hiba a Google √ºtemez√©sn√©l.'); b.textContent='Hiba'; return; }

        show($('#msg'),'ok','Eml√©keztet≈ëk √ºtemezve ‚úì');
        paintLinks(data);
        b.textContent='√útemezve ‚úì';
      }catch{
        show($('#msg'),'err','H√°l√≥zati hiba.'); b.textContent='Hiba';
      }finally{
        setTimeout(()=>{ b.disabled=false; b.textContent=prev; }, 2200);
      }
    });

    // Sz√©p linkgombok + m√°sol√°s
    function paintLinks(data){
      $('#last').style.display='block';
      $('#lastId').textContent = `ID: ${data.id}  ‚Ä¢  Kezd√©s: ${data.startsAt||'-'}`;

      const L = data.links || {};
      setupRow('Confirm', L.confirm, 'Visszaigazol√°s megnyit√°sa');
      setupRow('Cancel',  L.cancel,  'Lemond√°s megnyit√°sa');
      setupRow('Status',  L.status,  'St√°tusz megnyit√°sa');
    }
    function setupRow(kind, url, label){
      const row = $('#row'+kind);
      if (!url) { row.style.display='none'; return; }
      row.style.display='flex';
      $('#btn'+kind+'Open').onclick = ()=> window.open(url, '_blank');
      $('#btn'+kind+'Copy').onclick = async ()=>{
        try{ await navigator.clipboard.writeText(url); flash('#btn'+kind+'Copy','M√°solva ‚úì'); }
        catch{ flash('#btn'+kind+'Copy','Hiba'); }
      };
    }
    function flash(sel, txt){
      const el = $(sel); const prev = el.textContent;
      el.textContent = txt; el.disabled = true;
      setTimeout(()=>{ el.textContent = prev; el.disabled = false; }, 1200);
    }
  </script>
</body>
</html>
