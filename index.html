<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <title>No-Show Shield – Foglalás (teszt)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:560px;margin:40px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 16px}
    label{display:block;margin:10px 0 4px}
    input,select,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px}
    input,select{width:100%}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .actions{margin-top:16px;display:flex;gap:8px}
    .btn{cursor:pointer;background:#111;color:#fff;border:none;border-radius:8px;padding:10px 14px}
    .btn.secondary{background:#eee;color:#111}
    #result{margin-top:16px;border:1px solid #ddd;border-radius:10px;padding:12px;display:none}
    .linkbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{padding:8px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}
    code{background:#f6f8fa;padding:2px 6px;border-radius:6px}
    small{color:#666}
  </style>
</head>
<body>
  <h1>No-Show Shield – Időpont foglalás</h1>

  <form id="f">
    <label for="to">Ügyfél e-mail</label>
    <input id="to" name="to" type="email" placeholder="pl. kata.flowstatelabs@gmail.com" required />

    <div class="row">
      <div>
        <label for="minutes">Kezdés ennyi perc múlva</label>
        <select id="minutes" name="minutes" required>
          <option value="3">3 perc (teszt)</option>
          <option value="5">5 perc (teszt)</option>
          <option value="10">10 perc</option>
          <option value="30">30 perc</option>
          <option value="60">60 perc</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button class="btn" type="submit">Időpont rögzítése</button>
      <button class="btn secondary" type="reset">Űrlap törlése</button>
    </div>
    <small>A szervernek futnia kell: <code>node C:\nss\app.cjs</code>. Teszt mód: emlékeztetők −2 perc és −30 mp.</small>
  </form>

  <div id="result">
    <div id="msg"></div>
    <div class="linkbar">
      <a id="confirm" class="pill" target="_blank">Visszaigazolás</a>
      <a id="cancel"  class="pill" target="_blank">Lemondás</a>
      <a id="status"  class="pill" target="_blank">Státusz</a>
      <button id="copy" class="btn secondary" type="button">Linkek másolása</button>
    </div>
    <div style="margin-top:10px">
      <small>ID: <code id="aid"></code> • Kezdés: <code id="start"></code></small>
    </div>
  </div>

  <script>
    const BASE = "http://127.0.0.1:3001";
    const f = document.getElementById("f");
    const box = document.getElementById("result");
    const msg = document.getElementById("msg");
    const aid = document.getElementById("aid");
    const start = document.getElementById("start");
    const aConfirm = document.getElementById("confirm");
    const aCancel  = document.getElementById("cancel");
    const aStatus  = document.getElementById("status");
    const btnCopy  = document.getElementById("copy");

    f.addEventListener("submit", async (e) => {
      e.preventDefault();
      const to = document.getElementById("to").value.trim();
      const minutes = document.getElementById("minutes").value;
      msg.textContent = "Küldés…";
      box.style.display = "block";

      try {
        const r = await fetch(`${BASE}/schedule?to=${encodeURIComponent(to)}&minutes=${encodeURIComponent(minutes)}`);
        if (!r.ok) throw new Error("Hiba a szerver hívásakor");
        const data = await r.json();

        msg.textContent = `Időpont rögzítve és e-mail elküldve: ${data.to}`;
        aid.textContent = data.id;
        start.textContent = data.startsAt;
        aConfirm.href = data.confirm;
        aCancel.href  = data.cancel;
        aStatus.href  = data.status;

        // státusz poll 3 másodpercenként 30 másodpercig
        let tries = 10;
        const iv = setInterval(async () => {
          try {
            const sr = await fetch(data.status);
            const sj = await sr.json();
            msg.textContent = `Státusz: ${sj.status} • ${data.to}`;
            if (sj.status === "cancelled" || sj.status === "confirmed" || --tries === 0) clearInterval(iv);
          } catch {}
        }, 3000);

        btnCopy.onclick = async () => {
          const text = `Kezdés: ${data.startsAt}
Visszaigazolás: ${data.confirm}
Lemondás: ${data.cancel}
Státusz: ${data.status}`;
          await navigator.clipboard.writeText(text);
          btnCopy.textContent = "Kimásolva";
          setTimeout(()=>btnCopy.textContent="Linkek másolása", 1500);
        };
      } catch (e) {
        msg.textContent = "Hiba: " + e.message;
      }
    });
  </script>
</body>
</html>
