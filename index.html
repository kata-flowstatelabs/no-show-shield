<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>No-Show Shield ‚Äì Id≈ëpont foglal√°s</title>
  <style>
    body{font:16px system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:960px;margin:28px auto;padding:0 16px}
    h1{font-size:26px;margin:0 0 12px}
    h2{font-size:18px;margin:24px 0 8px}
    label{display:block;margin:12px 0 6px}
    input,select,button{font:16px system-ui;padding:10px 12px}
    input,select{width:100%}
    .row{display:flex;gap:10px;margin-top:14px}
    .muted{color:#666;font-size:14px;margin-top:8px}
    .events{border:1px solid #ddd;border-radius:8px;padding:8px}
    .event{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:8px 4px}
    .event:first-child{border-top:none}
    .event small{color:#555}
    .pill{padding:6px 10px;border:1px solid #ccc;border-radius:999px;background:#fafafa;cursor:pointer}
    .ok{color:#0a0}
    .err{color:#a00}
  </style>
</head>
<body>
  <header style="margin-bottom:12px">
    <a class="pill" href="/auth">üîê Google auth</a>
    <a class="pill" href="/send-test">send test</a>
    <a class="pill" href="/schedule">schedule</a>
    <a class="pill" href="/schedule-ghl">schedule GHL</a>
  </header>

  <h1>No-Show Shield ‚Äì Id≈ëpont foglal√°s</h1>

  <section>
    <h2>K√©zi teszt (percek alapj√°n)</h2>
    <label for="email">√úgyf√©l e-mail</label>
    <input id="email" type="email" placeholder="pl. kata.flowstatelabs@gmail.com" required>
    <label for="mins">Kezd√©s ennyi perc m√∫lva</label>
    <select id="mins">
      <option value="3">3 perc (teszt)</option>
      <option value="5">5 perc</option>
      <option value="15">15 perc</option>
      <option value="60">60 perc</option>
    </select>
    <div class="row">
      <button id="save">Id≈ëpont r√∂gz√≠t√©se</button>
      <button id="clear" type="button">≈∞rlap t√∂rl√©se</button>
    </div>
    <div id="msg" class="muted"></div>
  </section>

  <section>
    <h2>Google Calendar esem√©nyek</h2>
    <div class="muted">El≈ëbb jelentkezz be: <a href="/auth">/auth</a>. Ut√°na friss√≠tsd ezt az oldalt.</div>
    <div class="row" style="margin-top:8px">
      <button id="load">Esem√©nyek bet√∂lt√©se</button>
      <span id="gmsg" class="muted"></span>
    </div>
    <div id="events" class="events" style="display:none"></div>
  </section>

  <script>
    const $ = s => document.querySelector(s);
    const msg = t => $('#msg').textContent = t || '';
    const gmsg = t => { $('#gmsg').textContent = t || ''; };

    // K√©zi √ºtemez√©s
    $('#save').onclick = async () => {
      const email = $('#email').value.trim();
      const minutes = parseInt($('#mins').value, 10);
      if (!email) { msg('Adj meg egy e-mail c√≠met.'); return; }
      msg('√útemez√©s‚Ä¶');
      try {
        const r = await fetch('/schedule?to=' + encodeURIComponent(email) + '&minutes=' + minutes);
        if (!r.ok) { msg('Hiba az √ºtemez√©sn√©l.'); return; }
        const data = await r.json();
        msg('√útemezve. ID: ' + data.id);
      } catch { msg('H√°l√≥zati hiba.'); }
    };
    $('#clear').onclick = () => { $('#email').value=''; $('#mins').value='3'; msg(''); };

    // GCal lista + √ºtemez√©s
    $('#load').onclick = async () => {
      gmsg('Bet√∂lt√©s‚Ä¶');
      const box = $('#events');
      box.style.display = 'none';
      box.innerHTML = '';
      try {
        const r = await fetch('/gcal/upcoming');
        if (r.status === 401) { gmsg('Nincs Google enged√©ly. Katt: Google auth.'); return; }
        if (!r.ok) { gmsg('Lista hiba.'); return; }
        const data = await r.json();
        if (!data.events?.length) { gmsg('Nincs k√∂zelg≈ë esem√©ny.'); return; }
        data.events.forEach(e => {
          const div = document.createElement('div');
          div.className = 'event';
          const start = e.start || '';
          div.innerHTML =
            `<div><b>${e.summary || '(n√©vtelen)'}</b><br><small>${start}</small></div>
             <button class="pill" data-id="${e.id}">√útemez√©s erre</button>`;
          box.appendChild(div);
        });
        box.style.display = 'block';
        gmsg('');
      } catch { gmsg('H√°l√≥zati hiba.'); }
    };

    // Deleg√°lt kattint√°s: √útemez√©s erre
    document.addEventListener('click', async (ev) => {
      if (!(ev.target instanceof HTMLElement)) return;
      const id = ev.target.getAttribute('data-id');
      if (!id) return;
      const to = $('#email').value.trim();
      if (!to) { msg('Adj meg e-mail c√≠met a fels≈ë mez≈ëben.'); return; }
      ev.target.disabled = true;
      ev.target.textContent = '√útemez√©s‚Ä¶';
      try {
        const r = await fetch('/gcal/schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventId: id, to })
        });
        const ok = r.ok;
        ev.target.textContent = ok ? '√útemezve ‚úì' : 'Hiba';
        if (ok) msg('√útemezve a kiv√°lasztott esem√©nyre.');
        else msg('Hiba a GCal √ºtemez√©sn√©l.');
      } catch {
        ev.target.textContent = 'Hiba';
        msg('H√°l√≥zati hiba.');
      } finally {
        setTimeout(() => { ev.target.disabled = false; ev.target.textContent = '√útemez√©s erre'; }, 2500);
      }
    });
  </script>
</body>
</html>
